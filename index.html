<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SurveyorMap Pro - Plot Designer</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #1a1a1a; --accent: #2563eb; --success: #16a34a; --sidebar-w: 350px; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; overflow: hidden; }
        .app-layout { display: flex; height: 100vh; }

        /* Sidebar Controls */
        .sidebar {
            width: var(--sidebar-w); background: #ffffff; padding: 25px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1001;
            display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
        }
        h2 span { color: var(--accent); }
        .control-card { background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; }
        label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 8px; }
        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
        button { padding: 10px 15px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .secondary-btn { width: 100%; background: #475569; }
        .export-btn { width: 100%; background: var(--success); padding: 15px; font-size: 1rem; margin-top: auto; }

        /* Map Area */
        #capture-area { flex-grow: 1; position: relative; height: 100%; }
        #map { width: 100%; height: 100%; background: #e5e7eb; }

        /* Overlays */
        .map-overlay {
            position: absolute; bottom: 30px; left: 30px; background: white;
            padding: 20px; border-radius: 12px; z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); min-width: 250px; border-left: 5px solid var(--accent);
        }
        .overlay-header h3 { margin: 0; font-size: 1.1rem; }
        #display-coords { font-family: monospace; font-size: 0.8rem; color: #64748b; }
        
        /* Scale Bar Override */
        .leaflet-control-scale-line { 
            background: rgba(255,255,255,0.9); border: 2px solid #333; 
            border-top: none; color: #333; font-weight: bold; 
        }

        .stats-panel { font-size: 0.9rem; line-height: 1.6; }
    </style>
</head>
<body>

<div class="app-layout">
    <aside class="sidebar">
        <h2>SurveyorMap <span>Pro</span></h2>
        
        <div class="control-card">
            <label>1. Search Area</label>
            <div class="input-row">
                <input type="text" id="address-input" placeholder="Address or City">
                <button onclick="searchAddress()">Go</button>
            </div>
        </div>

        <div class="control-card">
            <label>2. Coordinates (Direct)</label>
            <div class="input-row">
                <input type="number" id="lat-input" placeholder="Lat" step="any">
                <input type="number" id="lon-input" placeholder="Lon" step="any">
            </div>
            <button class="secondary-btn" onclick="goToCoords()">Jump to GPS</button>
        </div>

        <div class="control-card">
            <label>3. Live Data</label>
            <div class="stats-panel">
                <div>Area: <strong id="area-val">0</strong> sqm</div>
                <div>Acres: <strong id="acres-val">0</strong> ac</div>
                <div>Perimeter: <strong id="perim-val">0</strong> m</div>
            </div>
        </div>

        <button class="export-btn" onclick="exportDesign()">Download PNG Image</button>
        <p style="font-size: 11px; color: #999;">Tip: Use the drawing tools on the top-left of the map to outline your plot.</p>
    </aside>

    <main id="capture-area">
        <div id="map"></div>
        <div class="map-overlay">
            <div class="overlay-header">
                <h3 id="display-name">Plot Design</h3>
                <span id="display-coords">0.000000, 0.000000</span>
            </div>
            <div id="overlay-stats" style="margin-top:10px; font-size: 0.8rem; color: #444;">
                No plot drawn yet.
            </div>
        </div>
    </main>
</div>

<script>
    let map;

    function initMap() {
        // Fix: Added height check and proper initialization
        map = L.map('map', { preferCanvas: true }).setView([6.5244, 3.3792], 12);

        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            crossOrigin: true, attribution: 'OSM'
        }).addTo(map);

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            crossOrigin: true, attribution: 'Esri'
        });

        L.control.layers({ "Map": osm, "Satellite": satellite }).addTo(map);
        L.control.scale({ imperial: false, position: 'bottomright' }).addTo(map);

        // Drawing tools
        map.pm.addControls({
            position: 'topleft',
            drawCircle: false,
            drawMarker: true,
            drawPolygon: true,
            editMode: true,
            removalMode: true
        });

        map.on('pm:create', (e) => {
            updateStats(e.layer);
            e.layer.on('pm:edit', () => updateStats(e.layer));
        });
    }

    function updateStats(layer) {
        if (layer instanceof L.Polygon) {
            const geojson = layer.toGeoJSON();
            const area = turf.area(geojson);
            const perim = turf.length(geojson, {units: 'meters'});
            const acres = (area * 0.000247105).toFixed(4);

            document.getElementById('area-val').innerText = area.toFixed(2);
            document.getElementById('acres-val').innerText = acres;
            document.getElementById('perim-val').innerText = perim.toFixed(2);
            document.getElementById('overlay-stats').innerText = `Area: ${acres} Acres | Perimeter: ${perim.toFixed(2)}m`;
        }
    }

    async function searchAddress() {
        const q = document.getElementById('address-input').value;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
        const data = await res.json();
        if (data[0]) moveMap(data[0].lat, data[0].lon, data[0].display_name);
    }

    function goToCoords() {
        const lat = document.getElementById('lat-input').value;
        const lon = document.getElementById('lon-input').value;
        if(lat && lon) moveMap(lat, lon, "Manual GPS Point");
    }

    function moveMap(lat, lon, name) {
        map.setView([lat, lon], 17);
        document.getElementById('display-name').innerText = name.split(',')[0];
        document.getElementById('display-coords').innerText = `${parseFloat(lat).toFixed(6)}, ${parseFloat(lon).toFixed(6)}`;
    }

    function exportDesign() {
        const area = document.getElementById('capture-area');
        // Temporarily hide map controls for a clean export
        const controls = document.querySelectorAll('.leaflet-control-container > div:not(.leaflet-control-scale)');
        controls.forEach(c => c.style.display = 'none');

        html2canvas(area, { useCORS: true, scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Survey-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            controls.forEach(c => c.style.display = 'block');
        });
    }

    window.onload = initMap;
</script>
</body>
</html>